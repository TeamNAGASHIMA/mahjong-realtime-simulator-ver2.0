<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tiles_save APIãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f4f4; }
        .form-group { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: white; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        input[type="text"], input[type="number"], input[type="file"], textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        button:hover { background-color: #1e7e34; }
        #response-output { margin-top: 30px; padding: 15px; background-color: #282c34; color: #ffffff; border: 1px solid #444; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
        .note { color: #6c757d; font-size: 0.85em; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>ğŸ’¾ `tiles_save` API ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ </h1>
    <p class="note">**Djangoã®CSRFãƒˆãƒ¼ã‚¯ãƒ³**ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚</p>

    <input type="hidden" id="csrfToken" value="FETCH_FROM_DJANGO_CONTEXT_OR_COOKIE">
    <div class="note">ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³: <span id="currentCsrfToken">å–å¾—ä¸­...</span></div>
    
    <div class="form-group">
        <label for="targetUrl">é€ä¿¡å…ˆURL</label>
        <input type="text" id="targetUrl" value="http://127.0.0.1:8010/app/tiles_save/" placeholder="ä¾‹: /app/tiles_save/">
    </div>
    
    <form id="saveDataForm">
        
        <div class="form-group">
            <label for="hand_tiles_image">æ‰‹ç‰Œç”»åƒ (hand_tiles_image)</label>
            <input type="file" id="hand_tiles_image" name="hand_tiles_image" accept="image/*" required>
        </div>

        <div class="form-group">
            <label for="board_tiles_image">ç›¤é¢ç”»åƒ (board_tiles_image) [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]</label>
            <input type="file" id="board_tiles_image" name="board_tiles_image" accept="image/*">
        </div>

        <div class="form-group">
            <label for="record_flag">è¨˜éŒ²ãƒ•ãƒ©ã‚° (record_flag)</label>
            <div class="note">0: ä½•ã‚‚ã—ãªã„ | 1: **è¨˜éŒ²ä¸­** (ä¸­é–“ãƒ‡ãƒ¼ã‚¿ä¿å­˜) | 2: **è¨˜éŒ²ä¿å­˜** (save_nameå¿…é ˆ)</div>
            <input type="number" id="record_flag" name="record_flag" value="1" min="0" max="2" required>
        </div>

        <div class="form-group">
            <label for="save_name">ä¿å­˜å (save_name)</label>
            <div class="note">record_flagãŒ2ã®å ´åˆã«å¿…è¦ã§ã™ã€‚</div>
            <input type="text" id="save_name" name="save_name" value="test_record_001">
        </div>

        <div class="form-group">
            <label for="fixes_board_info">ä¿®æ­£ãƒœãƒ¼ãƒ‰æƒ…å ± (fixes_board_info) - JSONå½¢å¼</label>
            <div class="note">å€¤ã¯æ”¹è¡Œã®ãªã„ä¸€è¡Œã«å›ºå®šã—ã¾ã—ãŸã€‚</div>
            <textarea id="fixes_board_info" name="fixes_board_info" rows="10" required>{"fixes_pai_info": {"version": "0.9.0","zikaze": 27,"bakaze": 27,"turn": 1,"syanten_type": 1,"dora_indicators": [],"flag": 0,"hand_tiles": [],"melded_blocks": [],"counts": []},"fixes_river_tiles": []}</textarea>
        </div>

        <button type="submit">POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡</button>
    </form>

    <div id="response-output">
        ã“ã“ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </div>

    <script>
        // MainScreen.jsã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const csrf = getCookie('csrftoken');
            document.getElementById('csrfToken').value = csrf || 'NOT_FOUND';
            document.getElementById('currentCsrfToken').textContent = csrf || 'è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (è¦ç¢ºèª)';
        });


        document.getElementById('saveDataForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const url = document.getElementById('targetUrl').value;
            const output = document.getElementById('response-output');
            const csrfToken = document.getElementById('csrfToken').value;

            output.textContent = 'é€ä¿¡ä¸­...';
            output.style.backgroundColor = '#007bff'; 
            output.style.color = 'white';
            
            if (!csrfToken || csrfToken === 'NOT_FOUND') {
                 output.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Djangoã®ç’°å¢ƒã§é–‹ã„ã¦ãã ã•ã„ã€‚';
                 output.style.backgroundColor = 'red';
                 return;
            }

            // FormDataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›† (ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’multipart/form-dataå½¢å¼ã§é€ä¿¡)
            const formData = new FormData(this);

            // ====================================================================
            // ã€â˜… ä¿®æ­£ç®‡æ‰€ï¼šJSONæ–‡å­—åˆ—ã‹ã‚‰æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦FormDataã‚’ä¸Šæ›¸ã â˜…ã€‘
            // JSONDecodeErrorå¯¾ç­–ã¨ã—ã¦ã€æ”¹è¡Œã®ãªã„JSONã‚’è¨­å®šæ¸ˆã¿ã ãŒã€å¿µã®ãŸã‚JSå´ã§é™¤å»ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ®‹ã™ã€‚
            // ====================================================================
            const rawJsonText = document.getElementById('fixes_board_info').value;
            
            // æ”¹è¡Œã‚³ãƒ¼ãƒ‰ï¼ˆ\rã¨\nï¼‰ã‚’ã™ã¹ã¦ç©ºæ–‡å­—ã«ç½®æ›ã—ã€å‰å¾Œã®ç©ºç™½ã‚‚é™¤å»ã—ã¦JSONæ–‡å­—åˆ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            const cleanedJsonText = rawJsonText.replace(/[\r\n]/g, '').trim();

            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸæ–‡å­—åˆ—ã‚’FormDataã«ã‚»ãƒƒãƒˆã—ç›´ã™ (ä¸Šæ›¸ã)
            formData.set('fixes_board_info', cleanedJsonText);
            // ====================================================================

            // record_flag=2ã®å ´åˆã®save_nameãƒã‚§ãƒƒã‚¯
            const recordFlag = formData.get('record_flag');
            const saveName = formData.get('save_name');

            if (recordFlag === '2' && (!saveName || saveName.trim() === '')) {
                output.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: record_flagãŒ2ã®å ´åˆã€save_nameã¯å¿…é ˆã§ã™ã€‚';
                output.style.backgroundColor = 'red';
                return;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 
                        // MainScreen.jsã¨åŒæ§˜ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨­å®š
                        'X-CSRFToken': csrfToken 
                    },
                    body: formData 
                });

                let responseData;
                const contentType = response.headers.get("content-type");

                if (contentType && contentType.indexOf("application/json") !== -1) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }
                
                // å¿œç­”ã®è¡¨ç¤º
                output.style.backgroundColor = response.ok ? '#1e1e1e' : 'red';
                output.textContent = `âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} (${response.statusText})\n\n`;
                if (typeof responseData === 'object') {
                    output.textContent += 'å¿œç­”JSON:\n' + JSON.stringify(responseData, null, 2);
                } else {
                    output.textContent += 'å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ:\n' + responseData;
                }

            } catch (error) {
                output.textContent = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
                output.style.backgroundColor = 'red';
                console.error('Error:', error);
            }
        });
    </script>

</body>
</html>